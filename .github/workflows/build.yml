name: Build KernelSU-Next GKI + SUSFS + ZeroMount

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: "Android Version"
        type: choice
        options: [android12, android13, android14, android15]
        default: android12
      kernel_version:
        description: "Kernel Version"
        type: choice
        options: ["5.10", "5.15", "6.1", "6.6"]
        default: "5.10"
      sub_level:
        description: "Sub Level"
        type: string
        default: "209"
      os_patch_level:
        description: "OS Patch Level (YYYY-MM)"
        type: string
        default: "2024-05"
      device_codename:
        description: "Device Codename (for stock kernel spoofing)"
        type: string
        default: "lake"

jobs:
  build:
    name: "KSU-Next-SUSFS-ZM ${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"
        rmz_version: "3.1.1"
        testing: false

    - name: Setup Build Environment
      run: |
        CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        cat >> $GITHUB_ENV << ENVEOF
        DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig
        CONFIG=$CONFIG
        KERNEL_ROOT=$KERNEL_ROOT
        ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3
        SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu
        KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches
        REPO=$GITHUB_WORKSPACE/git-repo/repo
        ZEROMOUNT_DIR=$GITHUB_WORKSPACE
        ENVEOF

        mkdir -p "$GITHUB_WORKSPACE/git-repo"
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o "$GITHUB_WORKSPACE/git-repo/repo"
        chmod 0755 "$GITHUB_WORKSPACE/git-repo/repo"
        echo "$GITHUB_WORKSPACE/git-repo" >> "$GITHUB_PATH"

    - name: Clone Dependencies
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git
        git clone https://github.com/ShirkNeko/SukiSU_patch.git
        git clone https://github.com/WildKernels/kernel_patches.git

    - name: Initialize and Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"

        repo init -u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=v2.16 --depth=1

        REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common ${FORMATTED_BRANCH})
        DEFAULT_MANIFEST_PATH=.repo/manifests/default.xml
        if grep -q deprecated <<< $REMOTE_BRANCH; then
          sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" $DEFAULT_MANIFEST_PATH
        fi

        repo --trace sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Extract Sublevel
      run: |
        ACTUAL_SUBLEVEL="${{ inputs.sub_level }}"
        if [[ -f "$KERNEL_ROOT/common/Makefile" ]]; then
          EXTRACTED=$(grep '^SUBLEVEL = ' "$KERNEL_ROOT/common/Makefile" | awk '{print $3}')
          [[ -n "$EXTRACTED" ]] && ACTUAL_SUBLEVEL="$EXTRACTED"
        fi

        ARTIFACT_BASE="${{ inputs.kernel_version }}.$ACTUAL_SUBLEVEL-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-KSU-Next-SUSFS-ZeroMount"
        echo "ACTUAL_SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
        echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> $GITHUB_ENV
        echo "FILE_NAME=$ARTIFACT_BASE" >> $GITHUB_ENV

    - name: Apply glibc 2.38 Compatibility Fix
      run: |
        if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
           [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
           [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]] ||
           [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" && $ACTUAL_SUBLEVEL -le 43 ]]; then
          GLIBC_VERSION=$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}')
          if [ "$(printf '%s\n' "2.38" "$GLIBC_VERSION" | sort -V | head -n1)" = "2.38" ]; then
            cd "$KERNEL_ROOT/common"
            sed -i '/\$(Q)\$(MAKE) -C \$(SUBCMD_SRC) OUTPUT=\$(abspath \$(dir \$@))\/ \$(abspath \$@)/s//$(Q)$(MAKE) -C $(SUBCMD_SRC) EXTRA_CFLAGS="$(CFLAGS)" OUTPUT=$(abspath $(dir $@))\/ $(abspath $@)/' tools/bpf/resolve_btfids/Makefile 2>/dev/null || true
            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
               [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
               [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]]; then
              sed -i '/char \*buf = NULL;/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++) {/for (i = 0; subcommands[i]; i++) {/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i '/if (subcommands) {/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++)/for (i = 0; subcommands[i]; i++)/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
            fi
          fi
        fi

    - name: Add KernelSU-Next with SUSFS
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding KernelSU-Next (dev_susfs branch) ==="
        curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/dev_susfs/kernel/setup.sh" | bash -s dev_susfs
        echo "=== KernelSU-Next added ==="

    - name: Fix SUSFS API Compatibility
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Aligning KernelSU-Next SUSFS API with custom fork ==="
        SUPERCALLS_FILE="$KERNEL_ROOT/KernelSU-Next/kernel/supercalls.c"
        if [ -f "$SUPERCALLS_FILE" ]; then
          sed -i 's/CMD_SUSFS_HIDE_SUS_MNTS_FOR_NON_SU_PROCS/CMD_SUSFS_HIDE_SUS_MNTS_FOR_ALL_PROCS/g' "$SUPERCALLS_FILE"
          echo "CMD constant alignment applied to supercalls.c"
        else
          echo "WARNING: supercalls.c not found at $SUPERCALLS_FILE"
        fi

        KSUD_FILE="$KERNEL_ROOT/KernelSU-Next/kernel/ksud.c"
        if [ -f "$KSUD_FILE" ]; then
          if ! grep -q "ksu_handle_sys_newfstatat" "$KSUD_FILE"; then
            echo "Adding ksu_handle_sys_newfstatat stub to ksud.c..."
            awk '/void ksu_handle_vfs_fstat/{found=1} found && /^}/{print; print "void ksu_handle_sys_newfstatat(int fd, loff_t *kstat_size_ptr) { }"; found=0; next}1' "$KSUD_FILE" > "$KSUD_FILE.tmp" && mv "$KSUD_FILE.tmp" "$KSUD_FILE"
            echo "ksu_handle_sys_newfstatat stub added"
          fi
        fi

        KCONFIG_FILE="$KERNEL_ROOT/KernelSU-Next/kernel/Kconfig"
        if [ -f "$KCONFIG_FILE" ] && ! grep -q "KSU_SUSFS_UNICODE_FILTER" "$KCONFIG_FILE"; then
          echo "Adding missing SUSFS Kconfig options..."
          cat >> "$KCONFIG_FILE" << 'KCONFIG_EOF'
        config KSU_SUSFS_UNICODE_FILTER
            bool "Enable UNICODE_FILTER"
            depends on KSU_SUSFS
            default y
            help
              Filter paths containing suspicious unicode characters.
        KCONFIG_EOF
          sed -i 's/^        //' "$KCONFIG_FILE"
          echo "UNICODE_FILTER Kconfig option added"
        fi

    - name: Apply Custom SUSFS Kernel Patches (All 11 Features)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Cloning Enginex0/susfs4ksu (custom fork with all features) ==="
        SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"
        git clone https://github.com/Enginex0/susfs4ksu.git -b "$SUSFS_BRANCH" "$SUSFS4KSU"

        echo "=== Injecting custom SUSFS command handler (add_sus_kstat_redirect) ==="
        SUPERCALLS_FILE="$KERNEL_ROOT/KernelSU-Next/kernel/supercalls.c"
        if [ -f "$SUPERCALLS_FILE" ] && ! grep -q "CMD_SUSFS_ADD_SUS_KSTAT_REDIRECT" "$SUPERCALLS_FILE"; then
          sed -i '/CMD_SUSFS_ADD_SUS_KSTAT_STATICALLY/,/#endif.*CONFIG_KSU_SUSFS_SUS_KSTAT/ {
            /#endif.*CONFIG_KSU_SUSFS_SUS_KSTAT/ i\
        if (cmd == CMD_SUSFS_ADD_SUS_KSTAT_REDIRECT) {\
            susfs_add_sus_kstat_redirect(arg);\
            return 0;\
        }
          }' "$SUPERCALLS_FILE"
          echo "Custom command handler injected into supercalls.c"
        else
          echo "Note: supercalls.c already has add_sus_kstat_redirect or file not found"
        fi

        echo "=== Applying SUSFS kernel patches ==="
        cd "$KERNEL_ROOT/common"

        cp "$SUSFS4KSU/kernel_patches/fs/susfs.c" ./fs/
        cp "$SUSFS4KSU/kernel_patches/include/linux/"*.h ./include/linux/

        SUSFS_PATCH="$SUSFS4KSU/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch"
        if [ -f "$SUSFS_PATCH" ]; then
          patch -p1 --no-backup-if-mismatch < "$SUSFS_PATCH"
        else
          echo "ERROR: SUSFS patch not found: $SUSFS_PATCH" && exit 1
        fi

        echo "=== Injecting Unicode filter hooks ==="
        cat > /tmp/inject_unicode.sh << 'UNICODE_SCRIPT'
        #!/bin/bash
        cd "$1"
        if ! grep -q "CONFIG_KSU_SUSFS_UNICODE_FILTER" fs/open.c; then
          sed -i '/#include "internal.h"/a #ifdef CONFIG_KSU_SUSFS_UNICODE_FILTER\n#include <linux\/susfs.h>\n#endif' fs/open.c
        fi
        if ! grep -q "susfs_check_unicode_bypass" fs/open.c; then
          sed -i '/^static int do_faccessat/,/^{/ { /^{/a #ifdef CONFIG_KSU_SUSFS_UNICODE_FILTER\n\tif (susfs_check_unicode_bypass(filename)) { return -ENOENT; }\n#endif
          }' fs/open.c
          sed -i '/^static long do_sys_openat2/,/struct filename \*tmp;/ { /struct filename \*tmp;/a #ifdef CONFIG_KSU_SUSFS_UNICODE_FILTER\n\tif (susfs_check_unicode_bypass(filename)) { return -ENOENT; }\n#endif
          }' fs/open.c
        fi
        if ! grep -q "CONFIG_KSU_SUSFS_UNICODE_FILTER" fs/stat.c; then
          sed -i '/#include "internal.h"/i #ifdef CONFIG_KSU_SUSFS_UNICODE_FILTER\n#include <linux\/susfs.h>\n#endif' fs/stat.c
        fi
        if ! grep -q "susfs_check_unicode_bypass" fs/stat.c; then
          sed -i '/^int vfs_fstatat/,/^{/ { /^{/a #ifdef CONFIG_KSU_SUSFS_UNICODE_FILTER\n\tif (filename \&\& susfs_check_unicode_bypass(filename)) { return -ENOENT; }\n#endif
          }' fs/stat.c
        fi
        UNICODE_SCRIPT
        chmod +x /tmp/inject_unicode.sh
        bash /tmp/inject_unicode.sh "$KERNEL_ROOT/common"
        echo "=== Unicode filter hooks injected ==="

        if [[ "${{ inputs.android_version }}" == "android12" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
          if [[ "$ACTUAL_SUBLEVEL" -le 209 ]]; then
            sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
          fi
        fi

        echo "=== Custom SUSFS patches applied ==="

    - name: Integrate ZeroMount VFS Hiding
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Integrating ZeroMount (SUSFS Partner) ==="

        cd common

        # Select appropriate ZeroMount patch based on kernel version
        if [[ "${{ inputs.kernel_version }}" == "6.6" || "${{ inputs.kernel_version }}" == "6.1" || "${{ inputs.kernel_version }}" == "5.15" ]]; then
          ZEROMOUNT_PATCH="$ZEROMOUNT_DIR/patches/zeromount-kernel-5.10.patch"
        else
          ZEROMOUNT_PATCH="$ZEROMOUNT_DIR/patches/zeromount-kernel-5.10.patch"
        fi

        echo "Applying ZeroMount patch: $ZEROMOUNT_PATCH"
        if [ -f "$ZEROMOUNT_PATCH" ]; then
          patch -p1 < "$ZEROMOUNT_PATCH"
        else
          echo "ERROR: ZeroMount patch not found: $ZEROMOUNT_PATCH"
          echo "Available patches:"
          ls -la "$ZEROMOUNT_DIR/patches/" || true
          exit 1
        fi

        # Verify core files created
        if [[ -f "fs/zeromount.c" ]] || [[ -f "fs/vfs_dcache.c" ]]; then
          echo "SUCCESS: ZeroMount core files created"
        else
          echo "WARNING: ZeroMount core files may have different names"
          ls -la fs/*.c | head -20 || true
        fi

        # Enable ZeroMount in defconfig
        echo "CONFIG_ZEROMOUNT=y" >> arch/arm64/configs/gki_defconfig

        echo "=== ZeroMount integration complete ==="

    - name: Upgrade LZ4 to v1.10.0 with ARM64 NEON
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Upgrading LZ4 to v1.10.0 ==="
        ZRAM_DIR="$GITHUB_WORKSPACE/zram"

        if [ -d "$ZRAM_DIR" ]; then
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c
          cp -r "$ZRAM_DIR/lz4/"* ./lib/lz4/ 2>/dev/null || true
          cp -r "$ZRAM_DIR/include/linux/"* ./include/linux/ 2>/dev/null || true

          if [ -f "$ZRAM_DIR/${{ inputs.kernel_version }}/lz4_1.10.0.patch" ]; then
            patch -p1 -F3 < "$ZRAM_DIR/${{ inputs.kernel_version }}/lz4_1.10.0.patch" || echo "LZ4 v1.10.0 patch skipped"
          fi

          if [ -f "lib/lz4/lz4armv8/lz4armv8.S" ]; then
            echo "SUCCESS: LZ4 ARM64 NEON assembly present"
          fi
        else
          echo "Note: zram directory not found, skipping LZ4 v1.10.0 upgrade"
        fi
        echo "=== LZ4 upgrade done ==="

    - name: Add LZ4K/LZ4KD Compression
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SUKISU="$GITHUB_WORKSPACE/SukiSU_patch"
        KERNEL_VER="${{ inputs.kernel_version }}"

        cp -r "$SUKISU/other/zram/lz4k/include/linux/"* ./include/linux/
        cp -r "$SUKISU/other/zram/lz4k/lib/"* ./lib/
        cp -r "$SUKISU/other/zram/lz4k/crypto/"* ./crypto/
        cp -r "$SUKISU/other/zram/lz4k_oplus" ./lib/

        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch"
        fi
        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" || echo "Note: lz4k_oplus patch skipped (optional)"
        fi

    - name: Configure Kernel (SUSFS + ZeroMount)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "${{ env.DEFCONFIG }}" << 'DEFEOF'
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_UNICODE_FILTER=y
        CONFIG_ZEROMOUNT=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        CONFIG_ZSMALLOC=y
        CONFIG_ZRAM=y
        CONFIG_ZRAM_WRITEBACK=y
        CONFIG_CRYPTO_LZ4=y
        CONFIG_CRYPTO_LZ4HC=y
        CONFIG_CRYPTO_LZ4K=y
        CONFIG_CRYPTO_LZ4KD=y
        CONFIG_CRYPTO_842=y
        CONFIG_CRYPTO_LZ4K_OPLUS=y
        CONFIG_ZRAM_DEF_COMP_LZ4KD=y
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_TCP_CONG_CUBIC=y
        CONFIG_TCP_CONG_BIC=n
        CONFIG_TCP_CONG_WESTWOOD=y
        CONFIG_TCP_CONG_HTCP=y
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y
        CONFIG_IP_SET_LIST_SET=y
        DEFEOF
        sed -i 's/^        //' "${{ env.DEFCONFIG }}"
        sed -i 's/CONFIG_ZRAM=m/CONFIG_ZRAM=y/g' "${{ env.DEFCONFIG }}"
        sed -i 's/CONFIG_ZSMALLOC=m/CONFIG_ZSMALLOC=y/g' "${{ env.DEFCONFIG }}"

        if [[ "${{ inputs.kernel_version }}" == "6.12" ]]; then
          sed -i '/name = "kernel_aarch64",/a\    check_defconfig = "disabled",' common/BUILD.bazel
        else
          sed -i 's/check_defconfig//' ./common/build.config.gki
        fi

    - name: Apply Performance Patches
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Applying Performance Patches ==="
        MIN_VERSION="5.16"

        cp "$KERNEL_PATCHES/common/optimized_mem_operations.patch" ./
        patch -p1 --forward < optimized_mem_operations.patch || echo "optimized_mem_operations skipped"

        cp "$KERNEL_PATCHES/common/file_struct_8bytes_align.patch" ./
        patch -p1 --forward < file_struct_8bytes_align.patch || echo "file_struct_8bytes_align skipped"

        cp "$KERNEL_PATCHES/common/reduce_cache_pressure.patch" ./
        patch -p1 --forward < reduce_cache_pressure.patch || echo "reduce_cache_pressure skipped"

        if [[ "$(printf '%s\n' "${{ inputs.kernel_version }}" "$MIN_VERSION" | sort -V | head -n1)" = "${{ inputs.kernel_version }}" ]]; then
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          patch -p1 --forward < clear_page_16bytes_align.patch || echo "clear_page_16bytes_align skipped"
        else
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch || echo "clear_page_16bytes_align__pi skipped"
        fi
        echo "=== Performance Patches Done ==="

    - name: Add BBG (Baseband Guard)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding BBG ==="
        curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
        echo "=== BBG Done ==="

    - name: Fix WiFi/BT on Xiaomi 6.6 GKI devices
      if: inputs.kernel_version == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Adding Xiaomi 6.6 WiFi/BT fix ==="
        SYMBOL_LIST=android/abi_gki_aarch64_xiaomi
        if [ -f "$SYMBOL_LIST" ]; then
          echo "device_find_any_child" >> $SYMBOL_LIST
          echo "SUCCESS: Added device_find_any_child to Xiaomi symbol list"
        else
          echo "Note: Xiaomi symbol list not found, skipping"
        fi

    - name: Apply Module Check Bypass
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Applying Module Check Bypass ==="
        if [[ "${{ inputs.kernel_version }}" == "6.1" || "${{ inputs.kernel_version }}" == "6.6" || "${{ inputs.kernel_version }}" == "6.12" ]]; then
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module/version.c"
        else
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module.c"
        fi

        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"

        if grep -A 5 "bad_version:" "$TARGET_FILE" | grep -q "return 1;"; then
          echo "SUCCESS: Module check bypass applied"
        else
          echo "WARNING: Module check bypass may not have applied"
        fi
        echo "=== Module Check Bypass Done ==="

    - name: Add Android 16/6.12 ashmem Exports
      if: inputs.android_version == 'android16' && inputs.kernel_version == '6.12'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding ashmem exports for Android 16 ==="
        FILE=common/drivers/staging/android/ashmem.c
        if [[ -f "$FILE" ]] && ! grep -q 'is_ashmem_file' "$FILE"; then
          cat >>"$FILE" <<'ASHMEM_EOF'
        bool is_ashmem_file(struct file *file) { return false; }
        int ashmem_area_name(struct file *file, char *name) { return 0; }
        long ashmem_area_size(struct file *file) { return 0; }
        struct file *ashmem_area_vmfile(struct file *file) { return NULL; }
        EXPORT_SYMBOL_GPL(is_ashmem_file);
        EXPORT_SYMBOL_GPL(ashmem_area_name);
        EXPORT_SYMBOL_GPL(ashmem_area_size);
        EXPORT_SYMBOL_GPL(ashmem_area_vmfile);
        ASHMEM_EOF
          sed -i 's/^        //' "$FILE"
          echo "SUCCESS: ashmem exports added"
        fi

        if [ -f common/drivers/android/binder/Makefile ]; then
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/binder/Makefile
          perl -i -pe 's/^rust_binder-\$\([^)]+\)\s*:=/rust_binder-y :=/' common/drivers/android/binder/Makefile
          rustup set profile minimal
          rustup update nightly
          rustup default nightly
          rustup target add aarch64-unknown-none
        else
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/Makefile 2>/dev/null || true
        fi
        echo "=== Android 16 ashmem exports done ==="

    - name: Clean Build Flags
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f "build/build.sh" ]; then
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
        else
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
        fi

    - name: Set Stock Build Identity
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        DEVICE_CODENAME="${{ inputs.device_codename }}"
        PROFILE_FILE="$GITHUB_WORKSPACE/device-profiles.json"

        if [ -f "$PROFILE_FILE" ] && command -v jq &> /dev/null; then
          DEVICE_EXISTS=$(jq -r ".devices.${DEVICE_CODENAME} // empty" "$PROFILE_FILE")

          if [ -n "$DEVICE_EXISTS" ]; then
            echo "=== Using device profile: $DEVICE_CODENAME ==="

            STOCK_RELEASE=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.release" "$PROFILE_FILE")
            STOCK_VERSION=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.version_string" "$PROFILE_FILE")
            STOCK_BUILD_USER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_user" "$PROFILE_FILE")
            STOCK_BUILD_HOST=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_host" "$PROFILE_FILE")

            echo "Stock release: $STOCK_RELEASE"
            echo "Stock version: $STOCK_VERSION"

            cat > scripts/setlocalversion << SETLOCAL_EOF
        #!/bin/sh
        printf '%s' "${STOCK_RELEASE}"
        SETLOCAL_EOF
            chmod +x scripts/setlocalversion

            if [ -f "scripts/mkcompile_h" ]; then
              sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"${STOCK_VERSION}\"|" scripts/mkcompile_h
              if grep -q "LINUX_COMPILE_BY=" scripts/mkcompile_h; then
                sed -i "s|LINUX_COMPILE_BY=.*|LINUX_COMPILE_BY=\"${STOCK_BUILD_USER}\"|" scripts/mkcompile_h
                sed -i "s|LINUX_COMPILE_HOST=.*|LINUX_COMPILE_HOST=\"${STOCK_BUILD_HOST}\"|" scripts/mkcompile_h
              fi
            fi

            echo "KBUILD_BUILD_USER=$STOCK_BUILD_USER" >> $GITHUB_ENV
            echo "KBUILD_BUILD_HOST=$STOCK_BUILD_HOST" >> $GITHUB_ENV
          else
            echo "WARNING: Device $DEVICE_CODENAME not found in profiles, using defaults"
          fi
        else
          echo "WARNING: device-profiles.json not found or jq not available"
        fi

    - name: Commit Changes
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Apply KernelSU-Next + SUSFS + ZeroMount + Stock Identity" || true

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f "build/build.sh" ]; then
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh || exit 1
        else
          tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist || exit 1
        fi

    - name: Compile ZeroMount Binary
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Compiling zm binary ==="
        ZM_SOURCE="${GITHUB_WORKSPACE}/src/zm.c"

        if [ ! -f "$ZM_SOURCE" ]; then
          echo "WARNING: zm.c source not found at $ZM_SOURCE, skipping binary compilation"
          exit 0
        fi

        sudo apt-get update -qq
        sudo apt-get install -qq -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

        CROSS_COMPILE="aarch64-linux-gnu-"

        echo "Compiling zm for aarch64..."
        ${CROSS_COMPILE}gcc -nostdlib -static -fPIE -pie \
          -o zm-aarch64 "$ZM_SOURCE" 2>/dev/null || \
        ${CROSS_COMPILE}gcc -nostdlib -static \
          -o zm-aarch64 "$ZM_SOURCE" 2>/dev/null || \
        ${CROSS_COMPILE}gcc -static \
          -o zm-aarch64 "$ZM_SOURCE" || echo "aarch64 compilation failed"

        echo "Compiling zm for arm..."
        arm-linux-gnueabi-gcc -nostdlib -static \
          -o zm-arm "$ZM_SOURCE" 2>/dev/null || \
        arm-linux-gnueabi-gcc -static \
          -o zm-arm "$ZM_SOURCE" || echo "arm compilation failed (optional)"

        chmod 755 zm-aarch64 2>/dev/null || true
        chmod 755 zm-arm 2>/dev/null || true

        if [ -f "zm-aarch64" ]; then
          echo "SUCCESS: zm-aarch64 compiled"
          file zm-aarch64
        fi
        if [ -f "zm-arm" ]; then
          echo "SUCCESS: zm-arm compiled"
          file zm-arm
        fi

    - name: Prepare AnyKernel3 Zip
      run: |
        if [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        else
          echo "ERROR: Cannot find kernel Image"
          find $KERNEL_ROOT -name "Image" -type f 2>/dev/null || true
          exit 1
        fi

        echo "=== Adding ZeroMount metamodule ==="
        ZEROMOUNT_MODULE="${GITHUB_WORKSPACE}/module"
        ZM_BIN_DIR="$ANYKERNEL3/modules/zeromount/bin"

        mkdir -p "$ZM_BIN_DIR"
        mkdir -p "$ANYKERNEL3/modules/zeromount"

        if [ -d "$ZEROMOUNT_MODULE" ]; then
          cp -r "$ZEROMOUNT_MODULE"/* "$ANYKERNEL3/modules/zeromount/"
          echo "SUCCESS: ZeroMount module files copied"
        else
          echo "WARNING: ZeroMount module directory not found at $ZEROMOUNT_MODULE"
        fi

        if [ -f "$KERNEL_ROOT/zm-aarch64" ]; then
          cp "$KERNEL_ROOT/zm-aarch64" "$ZM_BIN_DIR/zm"
          chmod 755 "$ZM_BIN_DIR/zm"
          echo "SUCCESS: zm binary added"
        else
          echo "WARNING: zm-aarch64 binary not found"
        fi

        if [ -f "$KERNEL_ROOT/zm-arm" ]; then
          cp "$KERNEL_ROOT/zm-arm" "$ZM_BIN_DIR/zm-arm"
          chmod 755 "$ZM_BIN_DIR/zm-arm"
        fi

        echo "=== ZeroMount module packaging complete ==="

    - name: Create ZRAM Module (Full Version)
      run: |
        echo "=== Creating KSU ZRAM module ==="
        ZRAM_MOD="$ANYKERNEL3/modules/data/adb/modules/zram_config"
        mkdir -p "$ZRAM_MOD/META-INF/com/google/android"

        cat > "$ZRAM_MOD/module.prop" << 'MODPROP'
        id=zram_config
        name=ZRAM 8GB LZ4 Configuration
        version=1.0
        versionCode=1
        author=Enginex0
        description=Configures ZRAM with 8GB size and LZ4 compression at boot. Compatible with Magisk/KernelSU.
        MODPROP
        sed -i 's/^        //' "$ZRAM_MOD/module.prop"

        cat > "$ZRAM_MOD/service.sh" << 'SERVICESH'
        #!/system/bin/sh
        MODDIR=${0%/*}
        LOG="$MODDIR/zram.log"

        log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG"
        }

        ZRAM_SIZE=8589934592
        ZRAM_ALGO=lz4
        MAX_STREAMS=8

        log "========================================="
        log "=== ZRAM Configuration Service Start ==="
        log "========================================="

        log "Waiting for system initialization..."
        sleep 30

        log "Stopping existing ZRAM swap..."
        swapoff /dev/block/zram0 2>/dev/null
        sleep 2

        log "Resetting ZRAM device..."
        echo 1 > /sys/block/zram0/reset 2>/dev/null
        sleep 1

        log "Setting max_comp_streams: $MAX_STREAMS"
        echo "$MAX_STREAMS" > /sys/block/zram0/max_comp_streams 2>/dev/null

        log "Setting compression algorithm: $ZRAM_ALGO"
        echo "$ZRAM_ALGO" > /sys/block/zram0/comp_algorithm 2>/dev/null

        log "Setting disksize: $ZRAM_SIZE bytes (8GB)"
        echo "$ZRAM_SIZE" > /sys/block/zram0/disksize 2>/dev/null

        log "Initializing swap partition..."
        mkswap /dev/block/zram0 > /dev/null 2>&1

        log "Enabling swap..."
        swapon /dev/block/zram0 > /dev/null 2>&1

        ACTUAL_SIZE=$(cat /sys/block/zram0/disksize 2>/dev/null)
        ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null | grep -o '\[.*\]' | tr -d '[]')
        [ -z "$ACTUAL_ALGO" ] && ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null)

        log "----------------------------------------"
        log "ZRAM Configuration Result:"
        log "  Size: $ACTUAL_SIZE bytes"
        log "  Algorithm: $ACTUAL_ALGO"
        log "----------------------------------------"

        MEM_INFO=$(free -h 2>/dev/null | grep -E "Mem:|Swap:")
        log "Memory Status:"
        log "$MEM_INFO"

        log "=== ZRAM Configuration Complete ==="
        SERVICESH
        sed -i 's/^        //' "$ZRAM_MOD/service.sh"
        chmod +x "$ZRAM_MOD/service.sh"

        cat > "$ZRAM_MOD/customize.sh" << 'CUSTOMIZESH'
        #!/system/bin/sh
        ui_print "========================================="
        ui_print "   ZRAM 8GB LZ4 Configuration Module"
        ui_print "   Author: Enginex0"
        ui_print "========================================="
        ui_print ""
        ui_print "Configuration:"
        ui_print "  - ZRAM Size: 8GB"
        ui_print "  - Algorithm: LZ4"
        ui_print "  - Streams: 8"
        ui_print ""
        ui_print "The module will configure ZRAM at boot."
        ui_print ""
        set_perm_recursive $MODPATH 0 0 0755 0644
        set_perm $MODPATH/service.sh 0 0 0755
        CUSTOMIZESH
        sed -i 's/^        //' "$ZRAM_MOD/customize.sh"
        chmod +x "$ZRAM_MOD/customize.sh"

        echo '#MAGISK' > "$ZRAM_MOD/META-INF/com/google/android/updater-script"

        cat > "$ZRAM_MOD/META-INF/com/google/android/update-binary" << 'UPDATEBIN'
        #!/sbin/sh
        umask 022
        TMPDIR=/dev/tmp
        rm -rf $TMPDIR 2>/dev/null
        mkdir -p $TMPDIR
        ui_print() { echo "$1"; }
        require_new_magisk() {
          ui_print "*******************************"
          ui_print " Please install Magisk v20.4+! "
          ui_print "*******************************"
          exit 1
        }
        OUTFD=$2
        ZIPFILE=$3
        mount /data 2>/dev/null
        [ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
        . /data/adb/magisk/util_functions.sh
        [ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk
        setup_flashable
        mount_partitions
        api_level_arch_detect
        $BOOTMODE && boot_actions || recovery_actions
        unzip -o "$ZIPFILE" module.prop -d $TMPDIR >&2
        [ ! -f $TMPDIR/module.prop ] && abort "! Unable to extract zip file!"
        $BOOTMODE && MODDIRNAME=modules_update || MODDIRNAME=modules
        MODULEROOT=$NVBASE/$MODDIRNAME
        MODID=$(grep_prop id $TMPDIR/module.prop)
        MODPATH=$MODULEROOT/$MODID
        rm -rf $MODPATH 2>/dev/null
        mkdir -p $MODPATH
        ui_print "- Extracting module files"
        unzip -o "$ZIPFILE" -d $MODPATH >&2
        rm -rf $MODPATH/META-INF 2>/dev/null
        set_perm_recursive $MODPATH 0 0 0755 0644
        [ -f $MODPATH/service.sh ] && set_perm $MODPATH/service.sh 0 0 0755
        $BOOTMODE && {
          mktouch $NVBASE/modules/$MODID/update
          cp -af $MODPATH/module.prop $NVBASE/modules/$MODID/module.prop
        }
        [ -f $MODPATH/sepolicy.rule ] && {
          ui_print "- Installing custom sepolicy rules"
          copy_sepolicy_rules
        }
        cd /
        $BOOTMODE || recovery_cleanup
        rm -rf $TMPDIR
        ui_print "- Done"
        exit 0
        UPDATEBIN
        sed -i 's/^        //' "$ZRAM_MOD/META-INF/com/google/android/update-binary"
        chmod +x "$ZRAM_MOD/META-INF/com/google/android/update-binary"

        echo "=== ZRAM module created ==="

    - name: Scan and Collect Patch Rejects
      if: always()
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Scanning for patch reject files ==="
        REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
        mkdir -p "$REJECTS_DIR"
        mapfile -t REJS < <(find . -type f -name '*.rej')
        REJ_COUNT=${#REJS[@]}
        echo "Found $REJ_COUNT .rej files"
        echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
        if [ "$REJ_COUNT" -gt 0 ]; then
          for REJ in "${REJS[@]}"; do
            REL="${REJ#./}"
            DEST="$REJECTS_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            cp "$REJ" "$DEST"
            ORIG="${REJ%.rej}"
            if [ -f "$ORIG" ]; then
              ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
              mkdir -p "$(dirname "$ORIG_DEST")"
              cp "$ORIG" "$ORIG_DEST"
            fi
          done
          echo "## Patch Rejects Found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          printf '%s\n' "${REJS[@]}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "No patch rejects found"
        fi

    - name: Upload Rejects
      if: always() && env.REJ_COUNT > 0
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-Rejects
        path: patch-rejects/
        if-no-files-found: ignore
        compression-level: 9

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-AnyKernel3
        path: ./AnyKernel3/**
        compression-level: 9

    - name: Build Summary
      run: |
        echo "## KernelSU-Next + SUSFS + ZeroMount Build" >> $GITHUB_STEP_SUMMARY
        echo "| Config | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Kernel | ${{ inputs.kernel_version }}.${{ env.ACTUAL_SUBLEVEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Android | ${{ inputs.android_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| KSU | KernelSU-Next (dev_susfs branch) |" >> $GITHUB_STEP_SUMMARY
        echo "| SUSFS | Enginex0/susfs4ksu (all 11 features) |" >> $GITHUB_STEP_SUMMARY
        echo "| ZeroMount | VFS-level path redirection (zero mounts) |" >> $GITHUB_STEP_SUMMARY
        echo "| ZRAM | LZ4K/LZ4KD 8GB |" >> $GITHUB_STEP_SUMMARY
        echo "| Device Profile | ${{ inputs.device_codename }} |" >> $GITHUB_STEP_SUMMARY
